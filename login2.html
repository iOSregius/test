<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<!--<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="https://raw.github.com/caolan/async/master/lib/async.js"></script>
<script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
<script src="http://documentcloud.github.com/backbone/backbone-min.js"></script>
-->
<script src="jquery.js"></script>
<script src="https://raw.github.com/caolan/async/master/lib/async.js"></script>
<script src="underscore.js"></script>
<script src="backbone.js"></script>
<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.1.min.js"></script>
<title>Backbone Facebook login @ Zsitro's Javascript Lab</title>
</head>
<body>
<button id="btnLogin">login</button>
<script>

  // Load the SDK Asynchronously
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));


window.fbAsyncInit = function() {
    FB.init({
      appId  : '252507681519662',
	  channelUrl : '//zsitro.com/applications/development/backbonelogin/channel.php',
      status : true, // check login status
      cookie : true, // enable cookies to allow the server to access the session
      xfbml  : true  // parse XFBML
    });

    FB.getLoginStatus(function(response){
        console.log('FB resp:', response,response.status);
		$('#btnLogin').on('click',function(){
			window.activeSession.login(
			{
				before:function(){console.log('before login()')},
				after:function(){console.log('after login()')}
			});
		});
    });

};  


SessionModel = Backbone.Model.extend({
    defaults: {
		id 				:null,
		third_party_id 	:null,
		name 			:null,
		email 			:null,
		status 			:0
    },

    isAuthorized: function(){
       return Boolean(this.get("third_party_id"));
    },

	logout : function(){
		window.activeSession.id = "";
		window.activeSession.clear();
		console.log('logout done!');
	},

	login : function(opts){
		console.log('#####################################\n login called.\n#####################################');
		
		opts.before&&opts.before();

		_session = this;
		this._onALWAYS	= function(){opts.after&&opts.after();};
		this._onERROR 	= function(){console.log('this._onERROR with result:',result);};
		this._onSUCCESS = function(result){
			console.log('this._onSUCCESS with result:',result);
			console.log(_session.get('third_party_id'));
		};
		
		this._getuserdata = function(callback){
			console.log('_getuserdata called;');
			FB.api('/me?fields=third_party_id,email,name,first_name', function(response) {
				if (!response || response.error) {					
					callback(true, response.error);
				} else {
				//window.location = "main.html"
					//alert('first name is ' + response['first_name']);
					abc(response);
					console.log('"/me" query success where username is ' + response['name'] + '.',response);					
					callback(null, response);
				}
			});

		};
		
		this._savesession = function(user,callback){
			console.log('_savesession called, user data:',user);
			/* if third_party_id exist its totally okay */
			if (user['third_party_id']){
				_session.set(
					{
						id: 			user['id'],
						third_party_id: user['third_party_id'],
						name: 			user['name'],
						email: 			user['email'],
						status: 		"1"
					},{
						silent:true
					}
				);									
				callback(null,"Everything is wonderful.");
			}
			else{
				callback(true,"third_party_id check failed!");
				return false;
			}
		}
		
		FB.login(function(response) {
			if (response.authResponse) {
				console.log('Fetching authResponse information.... ');

				async.waterfall([
					_session._getuserdata,
					_session._savesession,
				], function (err, result) {
					console.log('Queue finished. Error occured:',err,' result:',result);
					!!err&&_session._onERROR(result);
					!!!err&&_session._onSUCCESS(result);
					_session._onALWAYS(result);
				});
								
			} else {
				_session._onERROR('User cancelled login or did not fully authorize.');
			}
		}, {scope: 'email,user_likes'});
	}

});




window.activeSession = new SessionModel();
console.log('authorized after create (should be false):',window.activeSession.isAuthorized());


function abc(name)
{
	Parse.initialize("zMn02yNOwgNBU2gjZSazDAucWeeIIB7eaxnj3VEs", "vjC3XtjlKKNLfNhrLTHiYOQW7s1nc9wbXEaemdp5");
	var Post = Parse.Object.extend("Post");
	var post = new Post();
	//alert(name['first_name']);
	post.save({firstname: name['first_name'],email:name['email']}, {
	  success: function(object) {
		window.location = "main.html"
	  }
	});
}
</script>

</body>
</html>
